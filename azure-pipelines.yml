trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - models/
      - tests/
      - seeds/
      - snapshots/
      - macros/
      - dbt_project.yml
      - packages.yml
      - databricks.yml
      - profiles.yml
      - azure-pipelines.yml
      - requirements.txt

pr:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  pythonVersion: '3.11'
  PIP_CACHE_DIR: $(Pipeline.Workspace)/.pip
  DBT_PROFILES_DIR: $(Agent.HomeDirectory)/.dbt

stages:
  # ─────────────────────────────────────────────────────────────────────────────
  # Stage 1: Lint & Validate Code Quality
  # ─────────────────────────────────────────────────────────────────────────────
  - stage: Lint
    displayName: 'Lint dbt Code'
    condition: always()
    jobs:
      - job: DBTLint
        displayName: 'Validate dbt Project'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
              addToPath: true

          - task: Cache@2
            inputs:
              key: 'python | "$(Agent.OS)" | requirements.txt'
              path: $(PIP_CACHE_DIR)
            displayName: 'Cache pip packages'

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install dbt and dependencies'

          - script: |
              dbt parse
            displayName: 'Run dbt parse'

          - script: |
              dbt debug
            displayName: 'Run dbt debug'

          - script: |
              dbt compile
            displayName: 'Compile dbt models'

          - script: |
              dbt ls
            displayName: 'List all models'

  # ─────────────────────────────────────────────────────────────────────────────
  # Stage 2: Test Models (on Pull Requests)
  # ─────────────────────────────────────────────────────────────────────────────
  - stage: Test
    displayName: 'Test dbt Models'
    condition: eq(variables['Build.Reason'], 'PullRequest')
    dependsOn: Lint
    jobs:
      - job: DBTTest
        displayName: 'Test Models on Dev Environment'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
              addToPath: true

          - task: Cache@2
            inputs:
              key: 'python | "$(Agent.OS)" | requirements.txt'
              path: $(PIP_CACHE_DIR)
            displayName: 'Cache pip packages'

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install dependencies'

          - script: |
              mkdir -p $(DBT_PROFILES_DIR)
            displayName: 'Create dbt profiles directory'

          - script: |
              cat > $(DBT_PROFILES_DIR)/profiles.yml << 'EOF'
              databricks_medallion:
                target: dev
                outputs:
                  dev:
                    type: databricks
                    method: http
                    catalog: streaming_dev
                    schema: default
                    host: $(DATABRICKS_HOST)
                    http_path: $(DATABRICKS_HTTP_PATH)
                    token: $(DATABRICKS_TOKEN)
                    threads: 4
              EOF
            displayName: 'Generate profiles.yml'
            env:
              DATABRICKS_HOST: $(DATABRICKS_HOST)
              DATABRICKS_TOKEN: $(DATABRICKS_TOKEN)
              DATABRICKS_HTTP_PATH: $(DATABRICKS_HTTP_PATH)

          - script: |
              dbt deps
            displayName: 'Install dbt packages'

          - script: |
              dbt seed
            displayName: 'Load seed data'

          - script: |
              dbt run
            displayName: 'Run dbt models'

          - script: |
              dbt test
            displayName: 'Run dbt tests'
            continueOnError: false

          - script: |
              dbt docs generate
            displayName: 'Generate documentation'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/target'
              ArtifactName: 'dbt-test-artifacts'
              publishLocation: 'Container'
            condition: always()
            displayName: 'Upload dbt artifacts'

  # ─────────────────────────────────────────────────────────────────────────────
  # Stage 3: Deploy to Development
  # ─────────────────────────────────────────────────────────────────────────────
  - stage: DeployDev
    displayName: 'Deploy to Dev Environment'
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
    dependsOn: Lint
    jobs:
      - deployment: DeployToDev
        displayName: 'Deploy to streaming_dev'
        environment: 'development'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: UsePythonVersion@0
                  inputs:
                    versionSpec: '$(pythonVersion)'
                    addToPath: true

                - task: Cache@2
                  inputs:
                    key: 'python | "$(Agent.OS)" | requirements.txt'
                    path: $(PIP_CACHE_DIR)
                  displayName: 'Cache pip packages'

                - script: |
                    python -m pip install --upgrade pip
                    pip install -r requirements.txt
                  displayName: 'Install dependencies'

                - script: |
                    mkdir -p $(DBT_PROFILES_DIR)
                  displayName: 'Create dbt profiles directory'

                - script: |
                    cat > $(DBT_PROFILES_DIR)/profiles.yml << 'EOF'
                    databricks_medallion:
                      target: dev
                      outputs:
                        dev:
                          type: databricks
                          method: http
                          catalog: streaming_dev
                          schema: default
                          host: $(DATABRICKS_HOST)
                          http_path: $(DATABRICKS_HTTP_PATH)
                          token: $(DATABRICKS_TOKEN)
                          threads: 4
                    EOF
                  displayName: 'Generate profiles.yml'
                  env:
                    DATABRICKS_HOST: $(DATABRICKS_HOST)
                    DATABRICKS_TOKEN: $(DATABRICKS_TOKEN)
                    DATABRICKS_HTTP_PATH: $(DATABRICKS_HTTP_PATH)

                - script: |
                    dbt deps
                  displayName: 'Install dbt packages'

                - script: |
                    dbt seed --select "raw_*"
                  displayName: 'Load seed data'

                - script: |
                    dbt build --fail-fast
                  displayName: 'Run full dbt pipeline (seed → run → test)'

                - script: |
                    dbt docs generate
                  displayName: 'Generate documentation'

                - task: PublishBuildArtifacts@1
                  inputs:
                    PathtoPublish: '$(System.DefaultWorkingDirectory)/target'
                    ArtifactName: 'dbt-dev-artifacts-$(Build.BuildId)'
                    publishLocation: 'Container'
                  condition: always()
                  displayName: 'Upload dev artifacts'

                - script: |
                    echo "##[group]Deployment Summary"
                    echo "✅ Successfully deployed to streaming_dev"
                    echo "Branch: develop"
                    echo "Catalog: streaming_dev"
                    echo "Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
                    echo "##[endgroup]"
                  displayName: 'Print deployment summary'

  # ─────────────────────────────────────────────────────────────────────────────
  # Stage 4: Deploy to Production
  # ─────────────────────────────────────────────────────────────────────────────
  - stage: DeployProd
    displayName: 'Deploy to Production Environment'
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    dependsOn: Lint
    jobs:
      - deployment: DeployToProd
        displayName: 'Deploy to streaming_prod'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: UsePythonVersion@0
                  inputs:
                    versionSpec: '$(pythonVersion)'
                    addToPath: true

                - task: Cache@2
                  inputs:
                    key: 'python | "$(Agent.OS)" | requirements.txt'
                    path: $(PIP_CACHE_DIR)
                  displayName: 'Cache pip packages'

                - script: |
                    python -m pip install --upgrade pip
                    pip install -r requirements.txt
                  displayName: 'Install dependencies'

                - script: |
                    mkdir -p $(DBT_PROFILES_DIR)
                  displayName: 'Create dbt profiles directory'

                - script: |
                    cat > $(DBT_PROFILES_DIR)/profiles.yml << 'EOF'
                    databricks_medallion:
                      target: prod
                      outputs:
                        prod:
                          type: databricks
                          method: http
                          catalog: streaming_prod
                          schema: default
                          host: $(DATABRICKS_HOST)
                          http_path: $(DATABRICKS_HTTP_PATH)
                          token: $(DATABRICKS_TOKEN)
                          threads: 8
                    EOF
                  displayName: 'Generate profiles.yml'
                  env:
                    DATABRICKS_HOST: $(DATABRICKS_HOST)
                    DATABRICKS_TOKEN: $(DATABRICKS_TOKEN)
                    DATABRICKS_HTTP_PATH: $(DATABRICKS_HTTP_PATH)

                - script: |
                    dbt deps
                  displayName: 'Install dbt packages'

                - script: |
                    dbt seed --select "raw_*"
                  displayName: 'Load seed data'

                - script: |
                    dbt build --fail-fast
                  displayName: 'Run full dbt pipeline with validation'

                - script: |
                    dbt docs generate
                  displayName: 'Generate documentation'

                - task: PublishBuildArtifacts@1
                  inputs:
                    PathtoPublish: '$(System.DefaultWorkingDirectory)/target'
                    ArtifactName: 'dbt-prod-artifacts-$(Build.BuildId)'
                    publishLocation: 'Container'
                  condition: always()
                  displayName: 'Upload prod artifacts'

                - script: |
                    echo "##[group]Production Deployment Summary"
                    echo "✅ Successfully deployed to streaming_prod"
                    echo "Branch: main"
                    echo "Catalog: streaming_prod"
                    echo "Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
                    echo "Build ID: $(Build.BuildId)"
                    echo "Build Number: $(Build.BuildNumber)"
                    echo "##[endgroup]"
                  displayName: 'Print deployment summary'

  # ─────────────────────────────────────────────────────────────────────────────
  # Stage 5: Cleanup & Health Check
  # ─────────────────────────────────────────────────────────────────────────────
  - stage: Cleanup
    displayName: 'Cleanup & Validation'
    condition: always()
    dependsOn:
      - Lint
      - Test
      - DeployDev
      - DeployProd
    jobs:
      - job: HealthCheck
        displayName: 'Final Health Check'
        steps:
          - script: |
              echo "Pipeline execution completed successfully"
              echo "Build Status: $(Agent.JobStatus)"
            displayName: 'Pipeline summary'

          - script: |
              echo "##[group]Build Statistics"
              echo "Build ID: $(Build.BuildId)"
              echo "Build Number: $(Build.BuildNumber)"
              echo "Source Branch: $(Build.SourceBranch)"
              echo "Source Commit: $(Build.SourceVersion)"
              echo "Trigger: $(Build.Reason)"
              echo "##[endgroup]"
            displayName: 'Print build statistics'
